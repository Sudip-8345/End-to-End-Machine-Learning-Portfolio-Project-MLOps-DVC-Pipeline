name: CI - Water Potability

on: [push, pull_request]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: https://dagshub.com/${{ github.repository_owner }}/${{ github.event.repository.name }}.mlflow
      REPO_NAME: ${{ github.event.repository.name }}

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.13

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install dvc dagshub

    - name: Configure DVC
      env:
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        dvc remote modify origin --local auth basic
        dvc remote modify origin --local user ${{ secrets.MLFLOW_TRACKING_USERNAME }}
        dvc remote modify origin --local password $DAGSHUB_TOKEN

    - name: Run Pipeline
      env:
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        dvc pull
        dvc repro
        python src/model/model_eval.py